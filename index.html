<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Animated Video Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    textarea {
      width: 90%;
      height: 100px;
      margin-bottom: 10px;
    }
    .character-selection {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .char-thumb {
      width: 100px;
      height: 120px;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      padding: 5px;
    }
    .char-thumb.selected {
      border-color: #007bff;
    }
    .char-name {
      font-size: 14px;
      margin-top: 5px;
    }
    #animationContainer {
      width: 300px;
      height: 300px;
      margin: 20px auto;
      background: #f0f0f0;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<h2>ðŸŽ¬ Create Your Animated Video</h2>

<textarea id="scriptInput" placeholder="Type your script here..."></textarea>
<br>

<div class="character-selection" id="charactersDiv"></div>

<br>
<button id="generateBtn">Generate Video</button>
<br><br>
<div id="animationContainer"></div>
<br>
<button id="downloadAudioBtn" disabled>Download Audio</button>
<button id="downloadVideoBtn" disabled>Download Video</button>

<script>
  const characters = [
    {
      name: "Boss",
      thumbnails: "https://assets4.lottiefiles.com/packages/lf20_1pxqjqps.json",
      animations: {
        talking: "https://assets4.lottiefiles.com/packages/lf20_1pxqjqps.json"
      },
      voice: "Brian"
    },
    {
      name: "Seller",
      thumbnails: "https://assets3.lottiefiles.com/private_files/lf30_editor_pzjcpmra.json",
      animations: {
        talking: "https://assets3.lottiefiles.com/private_files/lf30_editor_pzjcpmra.json"
      },
      voice: "Emma"
    }
  ];

  const charactersDiv = document.getElementById("charactersDiv");
  const animationContainer = document.getElementById("animationContainer");
  const scriptInput = document.getElementById("scriptInput");
  const generateBtn = document.getElementById("generateBtn");
  const downloadAudioBtn = document.getElementById("downloadAudioBtn");
  const downloadVideoBtn = document.getElementById("downloadVideoBtn");

  let currentAudioUrl = "";
  let currentAnimation = null;
  let selectedCharacterIndex = 0;

  function loadCharacterThumbnails() {
    characters.forEach((char, i) => {
      const div = document.createElement('div');
      div.classList.add('char-thumb');
      div.dataset.index = i;

      const animDiv = document.createElement('div');
      animDiv.style.width = '80px';
      animDiv.style.height = '80px';
      div.appendChild(animDiv);

      // Load Lottie animation inside thumbnail
      lottie.loadAnimation({
        container: animDiv,
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: char.thumbnails
      });

      const nameSpan = document.createElement('div');
      nameSpan.classList.add('char-name');
      nameSpan.textContent = char.name;
      div.appendChild(nameSpan);

      div.addEventListener('click', () => {
        selectCharacter(i);
      });

      charactersDiv.appendChild(div);
    });

    selectCharacter(0);
  }

  function selectCharacter(index) {
    selectedCharacterIndex = index;
    const thumbs = document.querySelectorAll('.char-thumb');
    thumbs.forEach(thumb => thumb.classList.remove('selected'));
    thumbs[index].classList.add('selected');
  }

  function playAnimation(character) {
    if (currentAnimation) {
      currentAnimation.destroy();
    }
    animationContainer.innerHTML = '';
    currentAnimation = lottie.loadAnimation({
      container: animationContainer,
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: character.animations.talking
    });
  }

  async function generateAudio(text, voice) {
    const url = `https://api.streamelements.com/kappa/v2/speech?voice=${voice}&text=${encodeURIComponent(text)}`;
    return url;
  }

  async function playAudio(url) {
    const audio = new Audio(url);
    audio.play();
  }

  function downloadFile(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
  }

  async function recordVideo(durationSeconds = 10) {
    const stream = animationContainer.captureStream();
    const recorder = new MediaRecorder(stream);
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.start();

    await new Promise(resolve => setTimeout(resolve, durationSeconds * 1000));
    recorder.stop();

    return new Promise(resolve => {
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        resolve(url);
      };
    });
  }

  generateBtn.addEventListener('click', async () => {
    const script = scriptInput.value.trim();
    if (!script) return alert("Please enter a script!");

    const character = characters[selectedCharacterIndex];
    playAnimation(character);

    currentAudioUrl = await generateAudio(script, character.voice);
    await playAudio(currentAudioUrl);

    downloadAudioBtn.disabled = false;
    downloadVideoBtn.disabled = false;
  });

  downloadAudioBtn.addEventListener('click', () => {
    if (currentAudioUrl) {
      downloadFile(currentAudioUrl, 'audio.mp3');
    }
  });

  downloadVideoBtn.addEventListener('click', async () => {
    downloadVideoBtn.textContent = "Recording...";
    downloadVideoBtn.disabled = true;

    const videoUrl = await recordVideo(10);
    if (videoUrl) {
      downloadFile(videoUrl, "animation.webm");
    }

    downloadVideoBtn.textContent = "Download Video";
    downloadVideoBtn.disabled = false;
  });

  loadCharacterThumbnails();
</script>

</body>
</html>
