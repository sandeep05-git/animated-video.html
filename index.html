<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Text to Speech MP3 Generator</title>
</head>
<body>
  <h2>üé§ Enter Script and Generate MP3</h2>

  <textarea id="script" rows="5" cols="60" placeholder="Enter your script here...">Hello boss, this audio will be downloaded as MP3.</textarea><br><br>

  <label for="language">üåê Select Language:</label>
  <select id="language">
    <option value="en-US">English (US)</option>
    <option value="en-GB">English (UK)</option>
    <option value="hi-IN">Hindi</option>
    <option value="ta-IN">Tamil</option>
    <option value="te-IN">Telugu</option>
    <option value="mr-IN">Marathi</option>
  </select><br><br>

  <button id="generate">‚ñ∂Ô∏è Generate & Download MP3</button>

  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
  <script>
    const generateBtn = document.getElementById('generate');

    function getVoiceByLang(lang) {
      return speechSynthesis.getVoices().find(v => v.lang === lang);
    }

    generateBtn.onclick = async () => {
      const text = document.getElementById('script').value.trim();
      const lang = document.getElementById('language').value;
      if (!text) return alert("Enter your script first!");

      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang;
      const selectedVoice = getVoiceByLang(lang);
      if (selectedVoice) utter.voice = selectedVoice;

      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const dest = audioCtx.createMediaStreamDestination();
      const mediaRecorder = new MediaRecorder(dest.stream);
      const chunks = [];

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks);
        const arrayBuffer = await blob.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        const samples = audioBuffer.getChannelData(0);
        const mp3encoder = new lamejs.Mp3Encoder(1, audioBuffer.sampleRate, 128);
        const mp3Data = [];

        const sampleBlockSize = 1152;
        for (let i = 0; i < samples.length; i += sampleBlockSize) {
          const sampleChunk = samples.subarray(i, i + sampleBlockSize);
          const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
          if (mp3buf.length > 0) mp3Data.push(mp3buf);
        }

        const mp3buf = mp3encoder.flush();
        if (mp3buf.length > 0) mp3Data.push(mp3buf);

        const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });
        const url = URL.createObjectURL(mp3Blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "speech_output.mp3";
        a.click();
      };

      const source = audioCtx.createMediaStreamSource(dest);
      source.connect(audioCtx.destination);
      mediaRecorder.start();

      utter.onend = () => {
        mediaRecorder.stop();
      };

      synth.speak(utter);
    };

    // Load voices
    speechSynthesis.onvoiceschanged = () => {};
  </script>
</body>
</html>
