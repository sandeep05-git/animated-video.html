<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Animated Audio Generator</title>
</head>
<body>
  <h2>ЁЯОд Enter Script and Download Speech Audio</h2>

  <textarea id="script" rows="5" cols="60" placeholder="Enter your script here...">рдирдорд╕реНрддреЗ! рдореИрдВ рдЖрдкрдХреА рд╕рд╣рд╛рдпрддрд╛ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ рд╣реВрдБред</textarea><br><br>

  <label for="language">ЁЯМР Select Language:</label>
  <select id="language">
    <option value="en-US">English (US)</option>
    <option value="en-GB">English (UK)</option>
    <option value="hi-IN">Hindi</option>
    <option value="ta-IN">Tamil</option>
    <option value="te-IN">Telugu</option>
    <option value="mr-IN">Marathi</option>
  </select><br><br>

  <button id="generate">тЦ╢я╕П Generate & Play</button>
  <button id="download" style="display:none;">тмЗя╕П Download Audio</button>

  <script>
    const generateBtn = document.getElementById('generate');
    const downloadBtn = document.getElementById('download');
    const textarea = document.getElementById('script');
    const language = document.getElementById('language');

    let audioBlob = null;

    function getVoiceByLang(lang) {
      return speechSynthesis.getVoices().find(voice => voice.lang === lang);
    }

    generateBtn.onclick = async () => {
      const text = textarea.value.trim();
      const lang = language.value;
      if (!text) return alert("Please enter script text.");

      // Prepare audio context
      const audioContext = new AudioContext();
      const dest = audioContext.createMediaStreamDestination();
      const mediaRecorder = new MediaRecorder(dest.stream);
      const audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        downloadBtn.style.display = 'inline-block';
      };

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      const selectedVoice = getVoiceByLang(lang);
      if (selectedVoice) utterance.voice = selectedVoice;

      // Web Speech API Hack to route audio
      const synth = speechSynthesis;
      const utterThis = utterance;

      const source = audioContext.createMediaStreamSource(dest.stream);
      const gainNode = audioContext.createGain();
      gainNode.gain.value = 1;
      gainNode.connect(audioContext.destination);

      // Connect speech to audio context
      const audio = new Audio();
      const utterAudio = new SpeechSynthesisUtterance(text);
      utterAudio.lang = lang;
      if (selectedVoice) utterAudio.voice = selectedVoice;

      const synthAudio = new SpeechSynthesisUtterance();
      const dummy = new SpeechSynthesisUtterance();
      dummy.text = '';
      speechSynthesis.speak(dummy); // Required hack for Chrome

      const utteranceClone = new SpeechSynthesisUtterance(text);
      utteranceClone.lang = lang;
      if (selectedVoice) utteranceClone.voice = selectedVoice;

      // Connect system voice to audio context (only modern browsers)
      const oscillator = audioContext.createOscillator();
      oscillator.connect(dest);
      oscillator.start();
      oscillator.stop(audioContext.currentTime + 0.001); // hack to activate stream

      mediaRecorder.start();

      utteranceClone.onend = () => {
        mediaRecorder.stop();
      };

      speechSynthesis.speak(utteranceClone);
    };

    downloadBtn.onclick = () => {
      if (!audioBlob) return alert("No audio to download.");
      const url = URL.createObjectURL(audioBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'voice_output.wav';
      a.click();
    };

    // Load voices
    speechSynthesis.onvoiceschanged = () => {};
  </script>
</body>
</html>
