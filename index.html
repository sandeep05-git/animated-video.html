<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multilingual TTS with Manual Audio Download</title>
</head>
<body>
  <h2>Enter Script for Audio & Download</h2>
  <textarea id="script" rows="5" cols="60" placeholder="Enter your script here...">नमस्ते! मैं आपका ऑनलाइन सपोर्ट बॉट हूँ।</textarea><br><br>

  <label for="language">Select Language:</label>
  <select id="language">
    <option value="en-US">English (US)</option>
    <option value="en-GB">English (UK)</option>
    <option value="hi-IN">Hindi (India)</option>
    <option value="ta-IN">Tamil</option>
    <option value="te-IN">Telugu</option>
    <option value="mr-IN">Marathi</option>
  </select><br><br>

  <button id="play">Speak & Record</button>
  <button id="stop" disabled>Stop</button>
  <button id="download" style="display: none;">Download Audio</button>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    const playBtn = document.getElementById('play');
    const stopBtn = document.getElementById('stop');
    const downloadBtn = document.getElementById('download');
    const textArea = document.getElementById('script');
    const langSelect = document.getElementById('language');

    function getVoiceByLang(lang) {
      return speechSynthesis.getVoices().find(voice => voice.lang === lang);
    }

    playBtn.onclick = async () => {
      const lang = langSelect.value;
      const text = textArea.value.trim();
      if (!text) return alert("Please enter some script text.");

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      audioBlob = null;

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        downloadBtn.style.display = 'inline-block';
        stream.getTracks().forEach(track => track.stop());
      };

      mediaRecorder.start();

      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang;

      const selectedVoice = getVoiceByLang(lang);
      if (selectedVoice) utter.voice = selectedVoice;

      speechSynthesis.speak(utter);

      utter.onend = () => {
        mediaRecorder.stop();
        stopBtn.disabled = true;
      };

      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        stopBtn.disabled = true;
      }
    };

    downloadBtn.onclick = () => {
      if (!audioBlob) return alert("No audio recorded yet.");
      const url = URL.createObjectURL(audioBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'script_audio.wav';
      a.click();
    };

    window.speechSynthesis.onvoiceschanged = () => {};
  </script>
</body>
</html>
